import{j as e}from"./query-vendor-CL32O2jR.js";import{b as ke,o as g,p as we,L as Se,D as Le,q as Ce,g as N,r as U}from"./admin-pages-BGiHTXEV.js";import{r as n}from"./router-vendor-CjMceo_z.js";import{S as C}from"./ui-vendor-DAzBgmXi.js";import{D as Ae,L as De,C as Be,A as ze,p as He,a as Te,b as Ie,c as Me,P as $e,d as _e,e as Pe}from"./chart-vendor-Epm7qNnN.js";import"./index-DIw-UmDW.js";import"./utils-vendor-BmMXCZbk.js";import"./react-vendor-BZoW56qi.js";Be.register(ze,He,Te,Ie,Me,$e,_e,Pe);const We=({hadirCount:s,belumHadirCount:x,presentRate:p})=>{const c={labels:["Hadir","Belum Hadir"],datasets:[{data:[s,x],backgroundColor:["#14b8a6","#e5e7eb"],borderColor:["#0d9488","#d1d5db"],borderWidth:2,cutout:"70%"}]},A={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(v){const D=v.label||"",y=v.parsed,k=s+x,B=k>0?(y/k*100).toFixed(1):0;return`${D}: ${y} siswa (${B}%)`}}}}};return e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"relative w-32 h-32 mb-4",children:[e.jsx(Ae,{data:c,options:A}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsxs("span",{className:"text-2xl font-bold text-gray-900",children:[p,"%"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Kehadiran"})]})]}),e.jsx("div",{className:"w-full",children:e.jsx("p",{className:"text-lg font-semibold text-gray-900 text-center mb-3",children:"Persentase Kehadiran"})})]})})},Ee=({trendData:s})=>{const x={labels:s.map(c=>c.label),datasets:[{label:"Persentase Kehadiran",data:s.map(c=>c.rate),borderColor:"#0ea5e9",backgroundColor:"rgba(14, 165, 233, 0.1)",borderWidth:2,fill:!0,tension:.4,pointBackgroundColor:"#0ea5e9",pointBorderColor:"#0ea5e9",pointRadius:4,pointHoverRadius:6}]},p={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(c){return`Kehadiran: ${c.parsed.y.toFixed(1)}%`}}}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:function(c){return c+"%"}},grid:{color:"rgba(0, 0, 0, 0.1)"}},x:{grid:{display:!1}}}};return e.jsxs("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900",children:"Tren Kehadiran 7 Hari"}),e.jsx("div",{className:"w-full h-36",children:s.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-sm text-gray-500",children:"Tidak ada data tren."}):e.jsx(De,{data:x,options:p})})]})},Ze=()=>{const{user:s}=ke(),[x,p]=n.useState(0),[c,A]=n.useState(0),[v,D]=n.useState(0),[y,k]=n.useState(0),[B,q]=n.useState(0),[J,O]=n.useState(0),[Y,Z]=n.useState(0),[M,$]=n.useState([]),[Q,z]=n.useState(!0),[V,X]=n.useState(0),[ee,_]=n.useState([]),[ae,P]=n.useState(null),[f,se]=n.useState("hadir"),[te,W]=n.useState(!1),[E,w]=n.useState([]),[re,R]=n.useState({}),le=g(x,500),ie=g(c,500),ne=g(v,500),oe=g(y,500),de=g(B,500),ce=g(J,500),me=g(Y,500),{handleTotalSiswa:ue,handleSiswaHadirHariIni:xe,handleSiswaTerlambat:he,handleSiswaIzinHariIni:ge,handleSiswaSakitHariIni:be,loading:pe,error:H}=we();n.useEffect(()=>{(async()=>{try{const t=new Date().toISOString().slice(0,10),r=s?.role?.toLowerCase();console.log("âœ¨âœ¨âœ¨âœ¨userRole:",r);const[i,j,o,b,T,G]=await Promise.all([ue(),xe(),he(),ge(),be(),r==="gurket"||r==="walas"||r==="admin"?N.lihatAbsensiSiswa({tanggal:t}).catch(()=>null):Promise.resolve(null)]);p(i),A(j),D(o),k(b),q(T);const S=Number(i),l=Number(j),d=Number(o),m=G?.data?.responseData?.absensi??[],L=Array.isArray(m)?m.reduce((u,h)=>String(h.status).toLowerCase()==="alfa"?u+1:u,0):0;O(L);const I=S-l-d;if(Z(I),s?.role==="gurket"||s?.role==="admin"){const u=Math.round(l/S*100);X(u||0)}}catch(t){console.error("Error fetch dashboard data:",t)}})()},[]),n.useEffect(()=>{H&&C.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0}).fire({icon:"warning",title:H})},[H]),n.useEffect(()=>{(async()=>{if(s?.role==="walas")try{const r=(await N.walasInfo())?.data?.responseData;console.log(r),P(r)}catch{P(null)}})()},[s?.role]),n.useEffect(()=>{(async()=>{if(s?.role==="admin")try{const t=new Date,r=l=>String(l).padStart(2,"0"),i=l=>`${l.getFullYear()}-${r(l.getMonth()+1)}-${r(l.getDate())}`,b=((await U.rekap({tanggal:i(t)}))?.data?.rekap||[]).reduce((l,d)=>(l.hadir+=Number(d.hadir),l.terlambat+=Number(d.terlambat),l.izin+=Number(d.izin),l.sakit+=Number(d.sakit),l.alfa+=Number(d.alfa),l),{hadir:0,terlambat:0,izin:0,sakit:0,alfa:0}),T=Array.from({length:7}).map((l,d)=>{const m=new Date;return m.setDate(t.getDate()-(6-d)),m}),S=(await Promise.all(T.map(l=>U.rekap({tanggal:i(l)}).then(d=>({d:l,data:d?.data?.rekap||[]})).catch(()=>({d:l,data:[]}))))).map(({d:l,data:d})=>{const m=d.reduce((u,h)=>(u.hadir+=Number(h.hadir),u.terlambat+=Number(h.terlambat),u.izin+=Number(h.izin),u.sakit+=Number(h.sakit),u.alfa+=Number(h.alfa),u),{hadir:0,terlambat:0,izin:0,sakit:0,alfa:0}),L=m.hadir+m.terlambat+m.izin+m.sakit+m.alfa,I=L>0?Math.round(m.hadir/L*100):0;return{label:`${r(l.getDate())}/${r(l.getMonth()+1)}`,rate:I}});_(S)}catch{setGlobalStats({hadir:0,terlambat:0,izin:0,sakit:0,alfa:0,total:0}),_([])}})()},[s?.role]);const fe=async a=>{const t=["hadir","terlambat","izin","sakit"],r=s?.role?.toLowerCase();if(!t.includes(a)||r!=="gurket"&&r!=="walas"){w([]);return}W(!0);try{const i=await N.lihatAbsensiSiswa({status:a}),o=(i?.data?.responseData||i?.data||{})?.absensi||[];w(Array.isArray(o)?o:[])}catch{w([])}finally{W(!1)}},je=async(a,t,r,i)=>{if((await C.fire({title:"Konfirmasi Perubahan Status",html:`
        <div class="text-sm">
          <p><strong>Siswa:</strong> ${i}</p>
          <p><strong>Status Lama:</strong> <span class="capitalize">${r}</span></p>
          <p><strong>Status Baru:</strong> <span class="capitalize">${t}</span></p>
        </div>
      `,icon:"question",showCancelButton:!0,confirmButtonColor:"#3b82f6",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Ubah Status",cancelButtonText:"Batal"})).isConfirmed){R(o=>({...o,[a]:!0}));try{await N.updateAbsensiStatusAll({absensi_id:a,status:t}),w(o=>o.map(b=>b.absensi_id===a?{...b,status:t}:b)),C.fire({icon:"success",title:"Status Berhasil Diubah!",text:`Status kehadiran ${i} berhasil diubah menjadi ${t}`,confirmButtonColor:"#3b82f6",timer:3e3,timerProgressBar:!0})}catch(o){console.error("Error updating status:",o),C.fire({icon:"error",title:"Gagal Mengubah Status",text:o?.response?.data?.responseMessage||"Terjadi kesalahan saat mengubah status",confirmButtonColor:"#3b82f6"})}finally{R(o=>({...o,[a]:!1}))}}},Ne=({item:a})=>{const t=[{value:"hadir",label:"Hadir",color:"text-green-600"},{value:"terlambat",label:"Terlambat",color:"text-yellow-600"},{value:"izin",label:"Izin",color:"text-blue-600"},{value:"sakit",label:"Sakit",color:"text-red-600"},{value:"alfa",label:"Alfa",color:"text-gray-600"}],r=re[a.absensi_id];return e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:a.status,onChange:i=>je(a.absensi_id,i.target.value,a.status,a.nama),disabled:r,className:`
            w-full px-2 py-1 text-xs font-medium border border-gray-300 rounded-md
            focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
            ${r?"bg-gray-100 cursor-not-allowed":"bg-white cursor-pointer hover:bg-gray-50"}
            transition-colors duration-200
          `,children:t.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))}),r&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 rounded-md",children:e.jsx("svg",{className:"w-3 h-3 animate-spin text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})};n.useEffect(()=>{fe(f)},[f]);const K=a=>{switch(a){case"admin":return"Kepala Sekolah";case"gurket":return"Guru Piket";case"walas":return"Wali Kelas";default:return a}};n.useEffect(()=>{const a=s?.role?.toLowerCase();if(a==="admin"){z(!1),$([]);return}if(a!=="gurket"&&a!=="walas"){z(!1);return}const t=async()=>{try{const i=await N.aktifitasTerbaru();i.data.responseStatus&&$(i.data.responseData||[])}catch{}finally{z(!1)}};t();const r=setInterval(t,5e3);return()=>clearInterval(r)},[s?.role]);const ve=Number(x),F=Number(c),ye=Math.max(0,ve-F);return s?pe?e.jsx("div",{className:"flex min-h-screen bg-gray-50",children:e.jsx("div",{className:"flex flex-col flex-1",children:e.jsx("main",{className:"px-4 py-8 max-w-7xl sm:px-6 lg:px-14",children:e.jsx(Le,{})})})}):e.jsx("div",{className:"flex min-h-screen bg-gray-50",children:e.jsx("div",{className:"flex flex-col flex-1 ",children:e.jsxs("main",{className:"px-4 py-8 max-w-7xl sm:px-6 lg:px-14",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h2",{className:"mb-2 text-2xl font-bold text-gray-900",children:["Selamat datang, ",K(s.role),"ðŸ‘‹"]}),e.jsxs("p",{className:"text-gray-600",children:["Dashboard ",K(s.role)," -"," ",Ce(new Date)]})]}),(s.role==="gurket"||s.role==="admin")&&e.jsx("div",{className:"grid grid-cols-1 gap-6 mb-8 md:grid-cols-2 lg:grid-cols-3",children:e.jsx(We,{hadirCount:F,belumHadirCount:ye,presentRate:V})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 mb-8 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4",children:[e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Siswa"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:le})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-green-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Hadir"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ie})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-yellow-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-yellow-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Terlambat"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ne})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-purple-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-purple-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Izin"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:oe})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-red-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Sakit"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:de})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-gray-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Alfa"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce})]})]})}),e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-orange-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Belum Hadir"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:me})]})]})})]}),s.role==="walas"&&e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-indigo-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-indigo-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zm-8 8a6 6 0 0112 0v1H4v-1a6 6 0 014-6z"})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Status Wali Kelas"}),e.jsx("p",{className:"text-base font-semibold text-gray-900",children:ae?.kelas_label||"Memuat info kelas..."})]})]})})}),s.role==="admin"&&e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-2 mt-8",children:[e.jsx(Ee,{trendData:ee}),e.jsxs("div",{className:"p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900",children:"Aktivitas Terbaru"}),Q?e.jsx("p",{className:"text-sm text-gray-500",children:"Memuat aktivitas..."}):M.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Belum ada aktivitas terbaru."}):e.jsx("div",{className:"space-y-3",children:M.map((a,t)=>e.jsxs("div",{className:"flex items-center p-3 transition rounded-lg bg-gray-50 hover:bg-gray-100",children:[e.jsx("div",{className:`w-2 h-2 mr-3 rounded-full ${a.aksi==="created"?"bg-green-500":a.aksi==="updated"?"bg-yellow-500":a.aksi==="deleted"?"bg-red-500":"bg-gray-400"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-gray-900",children:a.deskripsi}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID Akun: ",a.akun_id||"-"," â€¢"," ",new Date(a.created_at).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})]})]})]},t))})]})]}),s.role==="walas"&&e.jsxs("div",{className:"mt-8 p-6 bg-white border border-gray-200 shadow-sm rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Daftar Siswa Hari Ini"}),e.jsx("div",{className:"flex gap-2",children:[{key:"hadir",label:"Hadir"},{key:"terlambat",label:"Terlambat"},{key:"izin",label:"Izin"},{key:"sakit",label:"Sakit"},{key:"alfa",label:"Alfa"},{key:"belum_hadir",label:"Belum Hadir"}].map(a=>e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),se(a.key)},className:`px-3 py-1.5 rounded-md text-sm ${f===a.key?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,children:a.label},a.key))})]}),te?e.jsx("p",{className:"text-sm text-gray-500",children:"Memuat data siswa..."}):E.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:["alfa","belum_hadir"].includes(f)?`Fitur daftar siswa untuk status "${f.replace("_"," ")}" belum tersedia.`:"Tidak ada data untuk status ini."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"table-base",children:[e.jsx("thead",{className:"table-thead",children:e.jsxs("tr",{children:[e.jsx("th",{className:"table-th",children:"NIS"}),e.jsx("th",{className:"table-th",children:"Nama"}),e.jsx("th",{className:"table-th",children:"Kelas"}),e.jsx("th",{className:"table-th",children:"Status"}),e.jsx("th",{className:"table-th",children:"Jam Datang"}),e.jsx("th",{className:"table-th",children:"Jam Pulang"})]})}),e.jsx("tbody",{className:"table-tbody",children:E.map((a,t)=>e.jsxs("tr",{className:"table-tr hover:bg-gray-50",children:[e.jsx("td",{className:"table-td",children:a.nis||"-"}),e.jsx("td",{className:"table-td",children:a.nama||"-"}),e.jsx("td",{className:"table-td",children:a.tingkat?`Kelas ${a.tingkat} ${a.jurusan||""} ${a.paralel||""}`:"-"}),e.jsx("td",{className:"table-td",children:a.absensi_id?e.jsx(Ne,{item:a}):e.jsx("span",{className:"capitalize text-gray-500",children:a.status||"-"})}),e.jsx("td",{className:"table-td",children:a.jam_datang||"-"}),e.jsx("td",{className:"table-td",children:a.jam_pulang||"-"})]},t))})]})})]})]})})}):e.jsx(Se,{text:"Memuat data user..."})};export{Ze as default};
