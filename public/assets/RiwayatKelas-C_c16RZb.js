import{j as e}from"./query-vendor-CL32O2jR.js";import{r as t}from"./router-vendor-CjMceo_z.js";import{S as r}from"./ui-vendor-DAzBgmXi.js";import{u as V,E as j,o as w,L as W,w as O}from"./admin-pages-BRzz_oB2.js";import"./react-vendor-BZoW56qi.js";import"./utils-vendor-BmMXCZbk.js";const ae=()=>{const[g,N]=t.useState([]),[c,M]=t.useState(""),[P,L]=t.useState([]),[R,K]=t.useState(!1),[C,A]=t.useState(null),[X,h]=t.useState(!1),[o,p]=t.useState(""),[d,$]=t.useState(!1),[u,b]=t.useState(null),[I,T]=t.useState(""),[x,B]=t.useState(!1),v=t.useCallback(async()=>{try{const s=(await V.listKelas())?.data?.responseData??[],l=Array.isArray(s)?s.map(i=>({id:i.kelas_id,label:`${i.tingkat??""} ${i.jurusan?.nama_jurusan??i.jurusan??""} ${i.paralel??""}`.trim()})):[];if(l.length===0)throw new j("empty");N(l)}catch{try{const l=(await w.getKelas())?.data?.responseData?.kelas??[],i=Array.isArray(l)?l.map(m=>({id:m.kelas_id,label:`${m.tingkat} ${m.jurusan?.nama_jurusan??""} ${m.paralel??""}`.trim()})):[];N(i)}catch{N([])}}},[]),f=t.useCallback(async()=>{K(!0),A(null);try{const a={};c&&(a.kelas_id=c);const s=await w.getRiwayatKelas(a),l=Array.isArray(s?.data?.responseData?.riwayat)?s.data.responseData.riwayat:[];L(l)}catch{A("Gagal memuat riwayat kelas")}finally{K(!1)}},[c]);t.useEffect(()=>{v()},[v]),t.useEffect(()=>{f()},[f]);const G=P,y=a=>{if(!a)return"-";const s=a.jurusan?.nama_jurusan??a.jurusan;return`${a.tingkat??""} ${s??""} ${a.paralel??""}`.trim()},_=a=>{b(a),T(a.status)},z=async()=>{if(u){B(!0);try{const a=await w.updateRiwayatKelas(u.riwayat_kelas_id,{status:I});if(a.status===200&&a.data.responseStatus)r.fire({icon:"success",title:"Berhasil",text:"Status riwayat berhasil diperbarui",timer:1500,showConfirmButton:!1}),b(null),f();else throw new j(a.data.responseMessage||"Gagal memperbarui status")}catch(a){r.fire({icon:"error",title:"Gagal",text:a?.response?.data?.responseMessage||"Terjadi kesalahan"})}finally{B(!1)}}},D=[{key:"no",label:"No",render:(a,s)=>s+1},{key:"nis",label:"NIS",sortable:!0,accessor:a=>a.siswa?.nis||"-"},{key:"nama",label:"Nama",sortable:!0,accessor:a=>a.siswa?.nama||"-"},{key:"kelas",label:"Kelas",sortable:!0,accessor:a=>y(a.kelas),sortValue:a=>y(a.kelas)},{key:"status",label:"Status",sortable:!0,accessor:a=>a.status||"-",render:a=>e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${a.status==="aktif"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:a.status||"-"})},{key:"actions",label:"Aksi",render:a=>e.jsx("button",{onClick:()=>_(a),className:"text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium",children:"Edit Status"})}],F=[a=>a.siswa?.nis||"",a=>a.siswa?.nama||"",a=>y(a.kelas),a=>a.status||""],H=async()=>{if(!o){r.fire({icon:"error",title:"Gagal",text:"Pilih kelas asal terlebih dahulu"});return}const a=g.find(n=>String(n.id)===String(o));if(!a){r.fire({icon:"error",title:"Gagal",text:"Kelas tidak ditemukan"});return}const s=a.label.split(" "),l=s[0],i=s.slice(1,-1).join(" "),m=s[s.length-1];let k;if(l==="X")k="XI";else if(l==="XI")k="XII";else if(l==="XII"){r.fire({icon:"error",title:"Gagal",text:"Siswa kelas XII tidak dapat naik tingkat lagi"});return}else{r.fire({icon:"error",title:"Gagal",text:"Format tingkat kelas tidak valid"});return}const S=`${k} ${i} ${m}`.trim();if((await r.fire({title:"Konfirmasi Kenaikan Tingkat",html:`
        <div class="text-left">
          <p><strong>Kelas Asal:</strong> ${a.label}</p>
          <p><strong>Kelas Tujuan:</strong> ${S}</p>
          <br>
          <p class="text-sm text-gray-600">Seluruh siswa di kelas ${a.label} akan dipindahkan ke kelas ${S}.</p>
          <p class="text-sm text-red-600 font-medium">Aksi ini tidak dapat dibatalkan!</p>
        </div>
      `,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya, Naik Tingkat",cancelButtonText:"Batal"})).isConfirmed){$(!0);try{const n=await w.promoteClass(o,{next_tingkat:k});if(n.status===200&&n.data.responseStatus)r.fire({icon:"success",title:"Berhasil!",text:`Seluruh siswa berhasil naik dari kelas ${a.label} ke ${S}`,timer:3e3,showConfirmButton:!1}),await f(),await v(),h(!1),p("");else throw new j(n.data.responseMessage||"Gagal memproses kenaikan tingkat")}catch(n){r.fire({icon:"error",title:"Gagal",text:n?.response?.data?.responseMessage||n.message||"Terjadi kesalahan saat memproses kenaikan tingkat"})}finally{$(!1)}}},E=t.useMemo(()=>g.filter(a=>{const s=a.label.split(" ")[0];return s==="X"||s==="XI"}),[g]);return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Riwayat Kelas Siswa"}),e.jsx("button",{onClick:()=>h(!0),className:"px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors font-medium",children:"Kelola Data Siswa"})]}),R&&e.jsx(W,{text:"Memuat riwayat kelas..."}),C&&e.jsx(j,{message:C}),X&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-md p-6 mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Kelola Data Siswa"}),e.jsx("button",{onClick:()=>{h(!1),p("")},className:"text-gray-400 hover:text-gray-600 text-2xl",disabled:d,children:"×"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Pilih Kelas Asal"}),e.jsxs("select",{value:o,onChange:a=>p(a.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none",disabled:d,children:[e.jsx("option",{value:"",children:"Pilih Kelas"}),E.map(a=>e.jsx("option",{value:a.id,children:a.label},a.id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Hanya kelas X dan XI yang dapat naik tingkat"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsx("h3",{className:"font-semibold text-blue-800 text-sm mb-2",children:"Aksi: Naik Tingkat Kelas"}),e.jsx("p",{className:"text-xs text-blue-700",children:"Seluruh siswa dalam kelas yang dipilih akan dipindahkan ke tingkat berikutnya secara otomatis."})]}),o&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Kelas Terpilih:"})," ",E.find(a=>String(a.id)===String(o))?.label]}),e.jsx("p",{className:"text-xs text-yellow-700 mt-1",children:"Siswa akan dipindahkan ke tingkat berikutnya dengan jurusan dan paralel yang sama."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:()=>{h(!1),p("")},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors",disabled:d,children:"Batal"}),e.jsxs("button",{onClick:H,disabled:!o||d,className:"px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[d&&e.jsxs("svg",{className:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),d?"Memproses...":"Naik Tingkat"]})]})]})}),u&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-md p-6 mx-4 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Edit Status Riwayat"}),e.jsx("button",{onClick:()=>b(null),className:"text-gray-400 hover:text-gray-600 text-2xl",disabled:x,children:"×"})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Siswa: ",e.jsx("strong",{children:u.siswa?.nama})," (",u.siswa?.nis,")"]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Kelas: ",e.jsx("strong",{children:y(u.kelas)})]}),e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:I,onChange:a=>T(a.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none",disabled:x,children:[e.jsx("option",{value:"aktif",children:"Aktif"}),e.jsx("option",{value:"naik kelas",children:"Naik Kelas"}),e.jsx("option",{value:"tidak naik kelas",children:"Tidak Naik Kelas"}),e.jsx("option",{value:"lulus",children:"Lulus"}),e.jsx("option",{value:"keluar",children:"Keluar"}),e.jsx("option",{value:"pindah",children:"Pindah"})]})]})}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:()=>b(null),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors",disabled:x,children:"Batal"}),e.jsxs("button",{onClick:z,disabled:x,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2",children:[x&&e.jsxs("svg",{className:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),x?"Menyimpan...":"Simpan Perubahan"]})]})]})}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end gap-3",children:[e.jsxs("div",{className:"flex flex-col text-sm",children:[e.jsx("label",{className:"text-gray-700 font-medium mb-1",children:"Filter Kelas"}),e.jsxs("select",{value:c,onChange:a=>M(a.target.value),className:"p-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200 min-w-48",children:[e.jsx("option",{value:"",children:"Semua Kelas"}),g.map(a=>e.jsx("option",{value:a.id,children:a.label},a.id))]})]}),e.jsx("div",{className:"text-xs text-gray-600 self-end pb-2",children:c?e.jsxs(e.Fragment,{children:["Filter: ",g.find(a=>String(a.id)===String(c))?.label]}):e.jsx(e.Fragment,{children:"Filter: Semua Kelas"})})]})}),e.jsx(O,{data:G,columns:D,searchFields:F,searchPlaceholder:"Cari NIS, nama siswa, kelas, atau status...",emptyMessage:"Tidak ada data riwayat kelas",defaultSort:{field:"nama",direction:"asc"},defaultItemsPerPage:25})]})};export{ae as default};
